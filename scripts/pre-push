#!/bin/bash
# Pre-push hook: runs tests before push to main
# Ensures all tests pass before code reaches the repository

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check if pushing to main
PUSHING_TO_MAIN=false

while read local_ref local_sha remote_ref remote_sha; do
    if [[ "$remote_ref" == *"main"* ]] || [[ "$remote_ref" == *"master"* ]]; then
        PUSHING_TO_MAIN=true
        break
    fi
done

# If not pushing to main, skip
if [ "$PUSHING_TO_MAIN" = false ]; then
    exit 0
fi

echo ""
echo "Running tests before push to main..."
echo ""

# Run pytest
if ! python -m pytest -v --tb=short; then
    echo ""
    echo -e "${RED}Tests failed. Fix tests before pushing.${NC}"
    echo ""
    echo "To bypass (not recommended): git push --no-verify"
    exit 1
fi

echo ""
echo -e "${GREEN}All tests passed. Proceeding with push...${NC}"
echo ""

exit 0
